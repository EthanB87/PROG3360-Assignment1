# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: CI Pipeline

on:
  push:
    branches: [ "main", "CI-CD-Adjustment" ]
  pull_request:
    branches: [ "main", "CI-CD-Adjustment" ] 

#Job 1: Build & Test
jobs:
  build-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: maven

      - name: Build services
        run: |
            mvn -f ProductService/pom.xml clean package
            mvn -f OrderService/pom.xml clean package


      - name: Run unit tests
        run: |
            mvn -f ProductService/pom.xml test -Dsurefire.failIfNoTests=false
            mvn -f OrderService/pom.xml test -Dsurefire.failIfNoTests=false

        #If there are no tests to run, the code will not break.

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/target/surefire-reports

# Job 2: Docker Build & Integration Test
docker-build:
  name: Docker Build & Integration Test
  runs-on: ubuntu-latest
  needs: build-test

  env:
    UNLEASH_API_URL: ${{ secrets.UNLEASH_API_URL }}
    UNLEASH_API_TOKEN: ${{ secrets.UNLEASH_API_TOKEN }}

  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker
      uses: docker/setup-buildx-action@v3

    - name: Build Docker images
      run: docker compose build

    - name: Start services
      run: docker compose up -d

    - name: Wait for services to be healthy
      run: |
        echo "Waiting for services to be ready..."
        for i in {1..15}; do
          prod_status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8081/actuator/health || true)
          order_status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8082/actuator/health || true)
          if [ "$prod_status" -eq 200 ] && [ "$order_status" -eq 200 ]; then
            echo "All services are healthy."
            break
          fi
          echo "Services not ready yet, retrying..."
          sleep 5
        done

    - name: Initialize Feature Flags in Unleash
      run: |
        echo "Initializing feature flags in Unleash..."
        for flag in premium-pricing bulk-order-discount order-notifications; do
          curl -s -X POST "$UNLEASH_API_URL/admin/features" \
            -H "Authorization: $UNLEASH_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"name\": \"$flag\", \"description\": \"Auto-created by CI\", \"enabled\": false}" \
            || echo "Flag $flag may already exist."
        done

    - name: Integration Test - Premium Pricing Flag
      run: |
        echo "Testing premium-pricing flag effect..."
        curl -s -X PUT "$UNLEASH_API_URL/admin/features/premium-pricing/environments/default/strategies" \
          -H "Authorization: $UNLEASH_API_TOKEN" \
          -H "Content-Type: application/json" \
          -d '[{"name":"default","parameters":{}}]'
        response=$(curl -s http://localhost:8081/api/products/premium)
        if [[ "$response" != *"premium"* ]]; then
          echo "ERROR: premium-pricing flag not affecting API"
          exit 1
        fi

    - name: Integration Test - Order Notifications Flag
      run: |
        echo "Testing order-notifications flag effect..."
        curl -s -X PUT "$UNLEASH_API_URL/admin/features/order-notifications/environments/default/strategies" \
          -H "Authorization: $UNLEASH_API_TOKEN" \
          -H "Content-Type: application/json" \
          -d '[{"name":"default","parameters":{}}]'
        response=$(curl -s -X POST http://localhost:8082/api/orders -d '{"productId":1,"quantity":1}' -H "Content-Type: application/json")
        if [[ "$response" != *"orderId"* ]]; then
          echo "ERROR: order-notifications flag not affecting order creation"
          exit 1
        fi

    - name: Integration Test - Bulk Order Discount Flag
      run: |
        echo "Testing bulk-order-discount flag effect..."
        curl -s -X PUT "$UNLEASH_API_URL/admin/features/bulk-order-discount/environments/default/strategies" \
          -H "Authorization: $UNLEASH_API_TOKEN" \
          -H "Content-Type: application/json" \
          -d '[{"name":"default","parameters":{}}]'
        response=$(curl -s -X POST http://localhost:8082/api/orders -d '{"productId":1,"quantity":10}' -H "Content-Type: application/json")
        if [[ "$response" != *"discountedPrice"* ]]; then
          echo "ERROR: bulk-order-discount flag not affecting order pricing"
          exit 1
        fi

    - name: Tear down
      if: always()
      run: docker compose down

# Job 3: Feature Flag Validation
feature-flag-check:
  name: Feature Flag Validation
  runs-on: ubuntu-latest
  needs: build-test

  env:
    UNLEASH_API_URL: ${{ secrets.UNLEASH_API_URL }}   # e.g., https://unleash.example.com/api
    UNLEASH_API_TOKEN: ${{ secrets.UNLEASH_API_TOKEN }}

  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: maven

    - name: Verify Feature Flags Exist in Unleash
      run: |
        echo "Checking if feature flags exist in Unleash..."
        for flag in premium-pricing bulk-order-discount order-notifications; do
          response=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: $UNLEASH_API_TOKEN" "$UNLEASH_API_URL/admin/features/$flag")
          if [ "$response" -ne 200 ]; then
            echo "ERROR: Feature flag '$flag' does not exist in Unleash."
            exit 1
          else
            echo "Feature flag '$flag' exists."
          fi
        done

    - name: Run ProductService Feature Flag Tests
      run: |
        echo "Running ProductService Feature Flag Unit Tests..."
        mvn -f ProductService/pom.xml test -Dtest=org.example.featureflag.FeatureFlagServiceTest -Dsurefire.failIfNoTests=false

    - name: Run OrderService Feature Flag Tests
      run: |
        echo "Running OrderService Feature Flag Unit Tests..."
        mvn -f OrderService/pom.xml test -Dtest=org.example.featureflag.FeatureFlagServiceTest -Dsurefire.failIfNoTests=false

#Bonus stuff can go below here
